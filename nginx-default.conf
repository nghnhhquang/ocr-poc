#/etc/nginx/conf.d/default.conf
http2  on;
#proxy_set_header  Accept-Encoding "";
#proxy_set_header  X-Real-IP $remote_addr;
#limit_req_zone $binary_remote_addr zone=loginzone:10m rate=30r/s;

upstream seadoc_be {
    server 10.62.0.150:17001; #80
}
upstream seafile_be1 {
    server 10.62.0.150:17002; #8000 / 80
}
upstream seafile_be2 {
    server 10.62.0.150:17003; #8082
}

upstream keycloak_be {
    server 10.62.0.150:30080;
    #server 127.0.0.1:8081;
    # You can add more servers here
    # Optional: weight=2 max_fails=3 fail_timeout=30s;
}
upstream ocr_be {
    server 10.62.0.150:8088;
}
upstream ocr_reconcile_be {
    server 10.62.0.150:8081;
}

upstream import_excel_be {
    server 10.62.0.150:9090;
}

# HTTP -> HTTPS redirect
server {
    listen 80;
    server_name filesohoa.toaan.gov.vn;
    return 301 https://$host$request_uri;
}
server {
    listen 80;
    server_name sohoahoso.toaan.gov.vn;
    return 301 https://$host$request_uri;
}
server {
  listen 443 ssl;
  server_name filesohoa.toaan.gov.vn;
  ssl_certificate /etc/nginx/certs/certificate.crt;
  ssl_certificate_key /etc/nginx/certs/private.key;

  location / {
    proxy_pass http://seafile_be1;
    proxy_read_timeout 310s;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Scheme $scheme;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $server_name;
    proxy_set_header Connection "";
    proxy_http_version 1.1;

    client_max_body_size 0;
  }
  location /sdoc-server/ {
    proxy_pass         http://seadoc_be/;
    proxy_redirect     off;
    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-Scheme $scheme;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Host  $server_name;

    client_max_body_size 100m;
  }

  location /socket.io {
    proxy_pass http://seadoc_be;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_redirect off;

    proxy_buffers 8 32k;
    proxy_buffer_size 64k;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Scheme $scheme;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
  }
  location /notification/ping {
    proxy_pass http://seafile_be2/ping;
  }
  location /notification {
    proxy_pass http://seafile_be2/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
}

server {
  listen 443 ssl;
  server_name sohoahoso.toaan.gov.vn;
  ssl_certificate /etc/nginx/certs/certificate.crt;
  ssl_certificate_key /etc/nginx/certs/private.key;

  proxy_set_header Host $host;
  proxy_set_header  X-ProxyScheme $scheme;
  proxy_set_header  X-ProxyHost $host;
  proxy_set_header  X-ProxyPort $server_port;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  X-Forwarded-Proto $scheme;
  proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;

  #proxy_hide_header X-Frame-Options;
  #proxy_hide_header Content-Security-Policy;
  #add_header        Content-Security-Policy "frame-ancestors http://${host}:* http://*.hanas.io";
  
  location / {   
    proxy_pass http://ocr_be;
    # SPA fallback
    proxy_intercept_errors on;
    error_page 404 = /index.html;
  }
  #location /login {
  #  limit_req zone=loginzone burst=30 delay=12;
  #  proxy_pass http://ocr:5500;
  #}
  location /api/ocr {
    #gzip off;
    #proxy_redirect          off;
    #proxy_cookie_flags ~ nosecure;
    #chunked_transfer_encoding off;
    #proxy_buffering off;
    proxy_pass http://ocr_reconcile_be;
  }
  location /assignments {
    proxy_pass http://import_excel_be;
  }
  location /import {
    proxy_pass http://import_excel_be;
  }
  location /ws {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_pass http://ocr_be;
  }
  location /realms {
    proxy_pass http://keycloak_be;
  }
  location /admin {
    proxy_pass http://keycloak_be;
  }
  location /resources {
    proxy_pass http://keycloak_be;
  }
  location /seafile/ {
    proxy_pass http://seafile_be1/;
    proxy_read_timeout 310s;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Scheme $scheme;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host  $server_name;
    proxy_set_header Connection "";
    proxy_http_version 1.1;

    client_max_body_size 0;
  }
}
